<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MindAR Diagnose</title>
<style>
  html,body{margin:0;overflow:hidden;font-family:system-ui}
  #panel{position:fixed;top:0;left:0;right:0;background:#111;color:#fff;padding:8px;z-index:10}
  #panel button{font-size:16px;padding:8px 12px;border-radius:8px;margin-right:8px}
  #log{font:12px/1.4 ui-monospace,Menlo,monospace;white-space:pre-wrap;margin-top:8px;max-height:36vh;overflow:auto}
  .ok{color:#0f0}.ng{color:#f66}
</style>

<div id="panel">
  <button id="startBtn">Start AR（カメラ起動）</button>
  <button id="testBack">Back Cam Test</button>
  <button id="testFront">Front Cam Test</button>
  <span id="status">INIT…</span>
  <div id="log"></div>
</div>

<script type="module">
const $ = s=>document.querySelector(s);
const log = (m, cls='')=>{
  const div=document.createElement('div'); div.textContent=m; if(cls) div.className=cls; $('#log').prepend(div);
};
const setStatus = (t)=> $('#status').textContent = t;

// 1) 事前チェック
try{
  log('Step0: location.protocol=' + location.protocol, location.protocol==='https:'?'ok':'ng');
  log('Step0: mediaDevices ' + (navigator.mediaDevices?'available':'MISSING'), navigator.mediaDevices?'ok':'ng');
}catch(e){ log('Step0 error: '+e, 'ng'); }

import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { MindARThree } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.esm.js';

log('Modules loaded: THREE & MindAR ESM', 'ok');

// 2) まず card.mind が本当に取れるか（ネット到達を確認）
const CARD_MIND = 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind';
try{
  const r = await fetch(CARD_MIND, {cache:'no-store'});
  log('Fetch card.mind: HTTP '+r.status+(r.ok?' OK':' NG'), r.ok?'ok':'ng');
  if(!r.ok){ throw new Error('card.mind fetch failed'); }
}catch(e){
  log('Fetch error: '+e, 'ng');
}

// 3) Three/MindARのセットアップ（ここは try 内で回す）
let mindarThree, renderer, scene, camera, anchor;
try{
  mindarThree = new MindARThree({
    container: document.body,
    imageTargetSrc: CARD_MIND,
    uiScanning: true,
    uiLoading: true,
    maxTrack: 1,
    videoSetting: { facingMode: { ideal: 'environment' } } // まず背面希望
  });
  ({renderer, scene, camera} = mindarThree);
  scene.add(new THREE.AmbientLight(0xffffff,1));
  log('MindARThree constructed', 'ok');

  anchor = mindarThree.addAnchor(0);
  anchor.onTargetFound = ()=>{ setStatus('FOUND'); log('FOUND', 'ok'); };
  anchor.onTargetLost  = ()=>{ setStatus('LOST');  log('LOST',  'ng'); };

  const plane = new THREE.Mesh(
    new THREE.PlaneGeometry(0.2,0.2),
    new THREE.MeshBasicMaterial({color:0x00ff00,transparent:true,opacity:0.4,side:THREE.DoubleSide})
  ); plane.rotation.x = -Math.PI/2;
  anchor.group.add(plane, new THREE.AxesHelper(0.15));

  const loop = ()=>{
    renderer.render(scene, camera);
    requestAnimationFrame(loop);
  }; loop();
  log('Render loop started', 'ok');
}catch(e){
  log('Setup error: '+e, 'ng');
}

async function startAR(tryFrontFallback=true){
  setStatus('Starting camera…');
  log('Call mindarThree.start()', 'ok');
  try{
    await mindarThree.start();  // ここで許可ダイアログ/起動
    setStatus('Scanning… show card.png on another screen');
    log('mindarThree.start() resolved', 'ok');
  }catch(e){
    log('start() failed: '+(e?.name||'')+' '+(e?.message||e), 'ng');
    if(tryFrontFallback){
      // 前面フォールバック
      try{ mindarThree.stop(); }catch{}
      try{ mindarThree.video.video.srcObject?.getTracks().forEach(t=>t.stop()); }catch{}
      mindarThree.params.videoSetting = { facingMode: 'user' };
      setStatus('Retry with Front camera…');
      log('Retry start() with facingMode=user');
      try{
        await mindarThree.start();
        setStatus('Scanning (front)…');
        log('mindarThree.start() (front) resolved', 'ok');
      }catch(e2){
        log('start(front) failed: '+(e2?.name||'')+' '+(e2?.message||e2), 'ng');
      }
    }
  }
}

// 生の getUserMedia でもデバイスが掴めるか（バック/フロント）
async function rawTest(which){
  try{
    if(mindarThree?.video?.video?.srcObject){
      mindarThree.video.video.srcObject.getTracks().forEach(t=>t.stop());
    }
    const s = await navigator.mediaDevices.getUserMedia({video:{facingMode: which}, audio:false});
    const v = document.createElement('video');
    v.style.position='fixed'; v.style.right='8px'; v.style.bottom= which==='environment'?'8px':'120px';
    v.style.width='160px'; v.muted=true; v.playsInline=true; v.autoplay=true; v.srcObject=s; v.play();
    document.body.appendChild(v);
    log(`raw getUserMedia(${which}) OK`, 'ok');
  }catch(e){
    log(`raw getUserMedia(${which}) failed: `+(e?.name||'')+' '+(e?.message||e), 'ng');
  }
}

// イベント
$('#startBtn').onclick = ()=> startAR(true);
$('#testBack').onclick = ()=> rawTest('environment');
$('#testFront').onclick = ()=> rawTest('user');
</script>
