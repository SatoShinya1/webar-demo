<!doctype html>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
<title>MindAR MIN</title>
<style>
  html,body{margin:0;overflow:hidden}
  #status{position:fixed;top:8px;left:50%;transform:translateX(-50%);
          padding:6px 10px;border-radius:8px;font:700 14px/1 system-ui;z-index:10;color:#fff;background:rgba(0,0,0,.6)}
  #error{position:fixed;left:0;right:0;top:0;background:#c00;color:#fff;padding:8px;display:none;z-index:30;
         font:12px/1.4 ui-monospace;white-space:pre-wrap}
</style>
<div id="error"></div>
<div id="status">INIT…</div>

<script type="module">
const $ = id => document.getElementById(id);
const showError = (msg) => { const e=$('error'); e.style.display='block'; e.textContent='ERROR: '+msg; };
const setStatus = (t, ok=false)=>{ const s=$('status'); s.textContent=t; s.style.background = ok?'rgba(0,160,0,.85)':'rgba(0,0,0,.6)'; };
window.addEventListener('error', ev=>showError(ev.message||String(ev.error||ev)));
window.addEventListener('unhandledrejection', ev=>showError(ev.reason?.message||String(ev.reason||ev)));

import * as THREE from 'https://unpkg.com/three@0.160.0/build/three.module.js';
import { MindARThree } from 'https://cdn.jsdelivr.net/npm/mind-ar@1.2.5/dist/mindar-image-three.esm.js';

setStatus('準備中…');

// 既知のカード .mind を使用（必ず存在）
// マーカー画像: https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.png
const CARD_MIND = 'https://cdn.jsdelivr.net/gh/hiukim/mind-ar-js@1.2.5/examples/image-tracking/assets/card-example/card.mind';

// まず .mind が取れるかチェック（CDN到達確認）
const r = await fetch(CARD_MIND, {cache:'no-store'});
if (!r.ok) throw new Error('Fetch card.mind failed: HTTP '+r.status);

import { AmbientLight, PlaneGeometry, MeshBasicMaterial, Mesh, AxesHelper, Group, BoxGeometry, MeshStandardMaterial, Vector3 } from 'https://unpkg.com/three@0.160.0/build/three.module.js';

const mindarThree = new MindARThree({
  container: document.body,
  imageTargetSrc: CARD_MIND,
  uiScanning: true,
  uiLoading: true,
  maxTrack: 1,
  videoSetting: { facingMode: { ideal: 'environment' } } // 背面希望
});

const { renderer, scene, camera } = mindarThree;
scene.add(new AmbientLight(0xffffff, 1));

const anchor = mindarThree.addAnchor(0);
anchor.onTargetFound = ()=> setStatus('FOUND #0', true);
anchor.onTargetLost  = ()=> setStatus('LOST  #0', false);

// 検出位置の可視化
const plane = new Mesh(new PlaneGeometry(0.2,0.2), new MeshBasicMaterial({color:0x00ff00, transparent:true, opacity:0.4, side:2}));
plane.rotation.x = -Math.PI/2;
anchor.group.add(plane, new AxesHelper(0.15));

// 立方体（プレースホルダー）
const group = new Group();
group.add(new Mesh(new BoxGeometry(0.15,0.15,0.15), new MeshStandardMaterial({ roughness:.8, color: 0x5555ff })));
anchor.group.add(group);

// 起動（ここでカメラ権限と起動）
try {
  setStatus('カメラ起動中…');
  await mindarThree.start();
  setStatus('スキャン中…（カード画像を映してください）');
} catch(e) {
  // 背面がダメなら前面で再試行
  try { mindarThree.stop(); } catch {}
  try { mindarThree.video.video.srcObject?.getTracks().forEach(t=>t.stop()); } catch {}
  mindarThree.params.videoSetting = { facingMode: 'user' };
  try {
    setStatus('前面で再試行…');
    await mindarThree.start();
    setStatus('スキャン中（前面）…');
  } catch (e2) {
    showError(e2?.message || String(e2));
    setStatus('カメラ開始失敗（サイト別カメラ許可/HTTPSを再確認）');
  }
}

// レンダリング
(function loop(){
  renderer.render(scene, camera);
  requestAnimationFrame(loop);
})();
</script>
